今日头条推荐系统&文本处理

今日头条推荐系统主要是面向资讯，因此会涉及大量的自然语言处理或者文本处理/挖掘工作。本文根据今日头条算法架构师曹欢欢分享的《今日头条推荐系统原理》，结合资讯推荐系统内容，整理出相关文本处理的关键点。

资讯推荐系统本质上是解决用户，环境以及资讯三方面因素的匹配，用形式化的方式去描述，其实是拟合一个用户在某种环境下对内容的满意度函数，即$y=F(x_i,x_u,x_c)$，其中$x_i$为资讯特征，$x_u$为用户特征，$x_c$为环境或上下文特征。资讯特征，用户特征包含人口特征（年龄、性别、职业等）、兴趣标签（显性兴趣标签、隐性兴趣标签）等，环境特征（当前所在地、常驻地、天气、所处状态（工作、通勤、旅游等））。结合这三方面的维度，模型会给出一个预估，将预测合适且能满足用户兴趣的内容推荐给目标用户。

推荐模型中，点击率、阅读时间、点赞、评论、转发都是可以被用于评估算法有效性的指标。但同时，对于一个有效且注重生态的推荐系统来说，引入数据指标以外的要素也很重要，如广告&特型内容频控，低俗内容打压&频控，标题党/低质/恶心内容打压，重要内容置顶&强插&加权，低级别账号内容降权。一些场景下，推荐的目标不完全是让用户浏览，还要考虑吸引用户回答为社区贡献内容，这些内容与普通内容如何混排，怎么样控制频控都需要考虑。另外，处于内容生态和社会责任的考量，像低俗内容的打压，标题党、地址内容的打压，重要新闻的置顶、加权、强插，低级别账号内容降权都是算法本身无法完成，需要对内容进行进一步干预。

推荐算法有很多，为了实现公式$y=F(x_i,x_u,x_c)$，可以采用协同过滤、热传导、LR、gbdt、图模型、FM，以及现在流行的深度学习（比如google提出的wide&deep模型、Collaborative Recurrent Neural Networks等）

推荐算法使用到的特征主要有四类：相关性特征、环境特征、热度特征、协同特征。
相关性特征评估内容的属性与用户是否匹配。显性的匹配包括关键词匹配、分类匹配、来源匹配、主题匹配等。像FM模型计算的是隐性匹配，从用户向量与内容向量的距离计算得出。环境特征包括地理位置、时间，这些既是bias特征，也能以此构建一些匹配特征。热度特征，包括全局热度、分类热度，主题热度，以及关键词热度等，内容热度信息在大的推荐系统特别是用户冷启动的时候非常有效。协同特征，可以在部分程度上帮助解决所谓算法越推越窄的问题，协同特征并非考虑用户已有历史，而是通过用户行为分析不同用户间相似性，比如点击相似，兴趣分类相似、主题相似、兴趣词相似，甚至向量相似，从而扩展模型的探索能力。

大规模推荐模型的在线训练，实时训练省资源并且反馈快，这对信息流产品非常重要。用户需要行为信息可以被模型快速捕捉并反馈至下一刷的推荐效果。线上基于storm集群实时处理数据，包括点击、展现、收藏、分享等动作类型。自研模型参数服务器。整体的训练过程是线上服务器记录实施特征，导入到kafka文件队列中，然后进一步导入storm集群消费kafka数据，客户端回传推荐的label构造训练样本，随后根据最新样本进行在线训练更新模型参数，最终线上模型得到更新。依赖用户的动作反馈，而动作反馈又是延时的，因为文章推荐后用户不一定马上看。

召回策略设计，头条内容量非常大，加上小视频内容有千万级别，推荐系统不可能所有内容全部由模型预估。所以需要设计一些召回策略，每次推荐时从海量内容中筛选出千级别的内容库。召回策略最重要的要求是性能要极致，一般超时不能超过50毫秒。

召回策略种类很多，主要使用倒排思路，离线维护一个倒排，倒排的key可以是分类、topic、实体、来源等，排序考虑热度、新鲜度、动作等。线上召回可以迅速从倒排中根据用户兴趣标签对内容做截断，高效的从很大的内容库中筛选比较靠谱的一小部分内容。

推荐系统依赖于数据。推荐模型的特征抽取需要用户侧和内容侧的各种标签，召回策略需要获取用户侧和内容侧的各种标签，内容分析和用户标签挖掘是挖掘推荐系统的基石。

内容分析包括文本分析，图片分析和视频分析。这里主要关注文本分析。文本分析在推荐系统中一个很重要的作用是用户兴趣建模。没有内容及文本标签，很难准确刻画用户兴趣标签，文章标签是互联网，用户看了互联网标签的文章，才能知道用户有互联网标签，其他关键词也一样。文本分析在推荐系统中的应用，用户兴趣建模，帮助内容推荐、生成频道内容。头条对一篇文章的关键词存储体系，分为一级分类（如体育新闻）、二级分类（体育新闻/网球）、关键词2（具体的关键词实体）、高亮关键词（基于已有词库）。总结来看就是这篇文章有分类、关键词、topic、实体词等文本特征。对资讯类产品而言，大部分是消费当天内容，没有文本特征，新内容冷启动非常困难，协同类特征无法解决文章冷启动问题。

头条推荐系统主要抽取的文本特征包含以下几类。首先是语义标签类特征，显式为文章打上语义标签。这部分标签是由人定义的特征，每个标签有明确的意义，标签体系是预定义的。此外还有隐式语义特征，主要是topic特征和关键词特征，其中topic特征是对于词概率分布的描述，无明确意义；而关键词特征会基于一些统一特征描述，无明确集合。

文本相似性特征可以应对重复推荐的问题。重复推荐问题的难点在于，每一个人对重复的定义是不一样的。举个例子，有人觉得这篇讲皇马和巴萨的文章，昨天已经看过类似内容，今天还说这两个队就是重复，但是对于重度球迷，尤其巴萨球迷，则不存在这样的问题，解决这个问题需要根据判断相似文章的主题、行文、主体等内容，根据这些特征做线上策略。同样，还需要考虑时空特征，内容的发生地点及时效性。最后还需要考虑质量相关特征，判断内容是否低俗，色情，是否软文，鸡汤。

语义标签包含分类、概念、实体。分类的目标是覆盖全面，每篇内容每段视频都有分类；而实体体系要求精准，相同名字或内容要能明确区分究竟指代哪一个人或物，但不用覆盖很全。概念体系则负责解决比较精确又属于抽象概念的语义。隐式语义特征已经可以很好的帮助推荐，而语义标签需要持续标注，新名词新概念不断出现，标注也要不断迭代。其做好的难度和资源投入要远大于隐式语义特征。语义特征可以用于频道，能够被容易理解和分类。

头条推荐系统的线上分类采用典型的层次化文本分类算法。最上面root，下面一层的分类是像科技、体育、财经、娱乐、体育这样的大类，再下面细分足球、篮球、乒乓球、网球等，足球再细分国际足球、中国足球，中国足球再细分中甲、中超、国家队等。层次化文本分类算法能更好地解决数据倾斜的问题。分类过程中，分类算法采用svm，有些结合cnn，有些结合rnn。

实体词识别算法，头条的做法为，基于分词结果和词性标注选取候选，期间可能需要根据知识库做一些拼接，有些实体是几个词的组合，要确定哪几个词结合在一起能映射实体的描述。如果结果映射多个实体还要通过词向量、topic分布甚至词频本身等去歧，最后计算一个相关性模型。

内容分析和用户标签是推荐系统的两大基石。头条的用户标签包括用户感兴趣的类别和主题、关键词、来源、基于兴趣的用户聚类以及各种垂直兴趣特征（车型、体育球队、股票等）。还有性别、年龄、地点信息等。性别信息通过用户第三方社交账号登录得到。年龄信息通常由模型预测，通过机型、阅读时间分布等预估。常驻地点来自用户授权访问位置信息。在位置信息的基础上通过传统聚类的方法拿到常驻点。常驻点结合其他信息，可以推测用户的工作地点、出差地点、旅游地点。这些用户标签非常有助于推荐。

当然最简单的用户标签是浏览过的内容标签。但这里涉及到一些数据处理策略。主要包括：一、过滤噪声。通过停留时间短的点击，过滤标题党。二、热点惩罚。对用户在一些热门文章上的动作降权处理。传播范围较大的内容，置信度会下降。三、时间衰减。用户兴趣会发生偏移，因此策略更偏向新的用户行为。因此随着用户动作的增加，老的特征权重会随时间衰减，新动作贡献的特征权重会更大。四、惩罚展现，如果一篇推荐给用户的文章没有被点击，相关特征（类别、关键词、来源）权重会被惩罚。同时也要考虑全局背景，是不是相关内容推送比较多，以及相关的关闭和dislike信号等。

特征的更新，兴趣标签等变化频率快的引入实时流式系统，像用户的性别、年龄、常驻地点这些信息，不需要实时重复计算，就仍然保留daily更新。

算法评价。对推荐效果可能产生影响的因素有很多，这里主要提到候选内容集合的变化，召回模块的改进和增加，推荐特征的增加，推荐系统架构的改进，算法参数的优化，规则策略的改变。一个良好的评估体系建立需要遵循几个原则：首先是兼顾短期目标和长期指标，兼顾用户指标和生态指标，协同效应影响。

头条A/B test实验系统的基本原理，首先会在离线状态下做好用户分桶，然后线上分配实验流量，将桶里用户打上标签，分给实验组。举个例子，开一个10%流量的实验，两个实验组各5%，一个5%是基线，策略和线上大盘一样，另外一个是新的策略。实验过程中用户动作会被搜集，基本上是准实时，每小时都可以看到。通常以天为时间节点。线上实验平台只能通过指标变化推测用户体验，数据指标和用户体验存在差异，重大改进需要人工评估二次确认，利用内部和外包团队进行例行的人工抽样评估。

信息可靠与安全。风险内容识别技术。鉴黄模型（构建千万张图片样本集，通过深度学习算法（ResNet）训练，召回率99%）。 低俗模型（对文本和图片同时分析，样本库超过百万，准确率80%+，召回率90%+）。不仅处理文章，也对评论做低俗识别。谩骂模型（净化产品评论氛围，识别出不当评论，样本库超过百万，召回率95%+，准确率80%+）。低质模型是通过对评论做情感分析，结合用户其它的负反馈信息（举报、不感兴趣、踩）等信息，来解决很多语义上的低质问题，诸如题文不符、有头无尾、拼凑编造、黑稿谣言等。泛低质识别涉及情况很多，像假新闻、黑稿、题文不符、标题党、内容质量低等等。


